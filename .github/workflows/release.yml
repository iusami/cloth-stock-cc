name: Release Build and Deploy

# ãƒªãƒªãƒ¼ã‚¹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼: ã‚¿ã‚°ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã®ã¿
on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0, v2.1.3 ãªã©ã®ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³

# æ¨©é™è¨­å®šï¼ˆGitHub Releaseã®ä½œæˆã«å¿…è¦ï¼‰
permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Build and Release APK
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    timeout-minutes: 45
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ï¼ˆãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆç”Ÿæˆç”¨ï¼‰
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Accept Android SDK licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
    # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’æŠ½å‡º
    - name: Extract version from tag
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "VERSION_CODE=$(echo $VERSION | sed 's/v//g' | sed 's/\\.//g')" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        
    # ãƒªãƒªãƒ¼ã‚¹å‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆå“è³ªä¿è¨¼ï¼‰
    - name: Run tests before release
      run: ./gradlew test --stacktrace
      
    # ãƒªãƒªãƒ¼ã‚¹APKãƒ“ãƒ«ãƒ‰
    - name: Build release APK
      run: ./gradlew assembleRelease --stacktrace
      env:
        VERSION_NAME: ${{ steps.version.outputs.VERSION }}
        VERSION_CODE: ${{ steps.version.outputs.VERSION_CODE }}
        
    # APKãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    - name: Verify APK exists
      run: |
        if [ ! -f app/build/outputs/apk/release/*.apk ]; then
          echo "Error: Release APK not found!"
          exit 1
        fi
        ls -la app/build/outputs/apk/release/
        
    # APKãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒãƒ¼ãƒ ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¿½åŠ ï¼‰
    - name: Rename APK with version
      run: |
        cd app/build/outputs/apk/release/
        APK_FILE=$(ls *.apk | head -1)
        VERSION=${{ steps.version.outputs.VERSION }}
        NEW_NAME="cloth-stock-${VERSION}.apk"
        mv "$APK_FILE" "$NEW_NAME"
        echo "Renamed APK to: $NEW_NAME"
        echo "APK_NAME=$NEW_NAME" >> $GITHUB_ENV
        
    # APKãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºæƒ…å ±å–å¾—
    - name: Get APK info
      id: apk_info
      run: |
        cd app/build/outputs/apk/release/
        APK_SIZE=$(stat -c%s "$APK_NAME" | numfmt --to=iec)
        echo "APK_SIZE=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "APK size: $APK_SIZE"
        
    # GitHub Releaseã‚’ä½œæˆ
    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.VERSION }}
        release_name: Cloth Stock ${{ steps.version.outputs.VERSION }}
        body: |
          ## ğŸ‰ Cloth Stock ${{ steps.version.outputs.VERSION }} ãƒªãƒªãƒ¼ã‚¹
          
          ### ğŸ“± ã‚¢ãƒ—ãƒªæƒ…å ±
          - **APKã‚µã‚¤ã‚º**: ${{ steps.apk_info.outputs.APK_SIZE }}
          - **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}
          
          ### ğŸ“‹ å¤‰æ›´å†…å®¹
          ã“ã®ãƒªãƒªãƒ¼ã‚¹ã®è©³ç´°ãªå¤‰æ›´å†…å®¹ã«ã¤ã„ã¦ã¯ã€[ã‚³ãƒŸãƒƒãƒˆå±¥æ­´](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}...HEAD)ã‚’ã”ç¢ºèªãã ã•ã„ã€‚
          
          ### ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. ä¸‹è¨˜ã® `cloth-stock-${{ steps.version.outputs.VERSION }}.apk` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. Androidç«¯æœ«ã§ã€Œæä¾›å…ƒä¸æ˜ã®ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã‚’è¨±å¯
          3. APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          
          ### âš ï¸ æ³¨æ„äº‹é …
          - ã“ã®ã‚¢ãƒ—ãƒªã¯ãƒ‡ãƒãƒƒã‚°ç”¨ã®é–‹ç™ºç‰ˆã§ã™
          - Android 7.0 (API level 24) ä»¥ä¸ŠãŒå¿…è¦ã§ã™
          - åˆå›å®Ÿè¡Œæ™‚ã«ã‚«ãƒ¡ãƒ©æ¨©é™ã®è¨±å¯ãŒå¿…è¦ã§ã™
          
          ---
          
          ğŸ¤– ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
        draft: false
        prerelease: false
        
    # APKãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªãƒªãƒ¼ã‚¹ã‚¢ã‚»ãƒƒãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    - name: Upload APK to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: app/build/outputs/apk/release/${{ env.APK_NAME }}
        asset_name: ${{ env.APK_NAME }}
        asset_content_type: application/vnd.android.package-archive
        
    # ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç”¨ï¼‰
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.version.outputs.VERSION }}
        path: |
          app/build/outputs/apk/release/*.apk
          app/build/outputs/mapping/release/
        retention-days: 90
        
    # ãƒªãƒªãƒ¼ã‚¹å¤±æ•—æ™‚ã®é€šçŸ¥ï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
    - name: Notify on release failure
      if: failure()
      run: |
        echo "::error::Release build failed for version ${{ steps.version.outputs.VERSION }}"
        echo "Check the build logs for detailed error information."
        
    # ãƒªãƒªãƒ¼ã‚¹æˆåŠŸæ™‚ã®ã‚µãƒãƒªãƒ¼
    - name: Release summary
      if: success()
      run: |
        echo "::notice::Successfully released Cloth Stock ${{ steps.version.outputs.VERSION }}"
        echo "::notice::APK size: ${{ steps.apk_info.outputs.APK_SIZE }}"
        echo "::notice::Release URL: ${{ steps.create_release.outputs.html_url }}"