name: Continuous Integration

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒpush + mainã¸ã®PRï¼ˆé‡è¤‡å®Ÿè¡Œæ’é™¤ï¼‰
on:
  push:
    branches: [ 'main' ]  # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼ˆãƒãƒ¼ã‚¸å¾Œã®å“è³ªç¢ºèªï¼‰
  pull_request:
    branches: [ 'main' ]  # mainã¸ã®PRã®ã¿ï¼ˆé–‹ç™ºãƒ†ã‚¹ãƒˆï¼‰

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼ˆåŒã˜PRã§è¤‡æ•°å›å®Ÿè¡Œæ™‚ã¯æœ€æ–°ã®ã¿ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # çµ±åˆã•ã‚ŒãŸé«˜é€ŸCIã‚¸ãƒ§ãƒ– - æœ€ã‚‚é‡è¦ãªãƒã‚§ãƒƒã‚¯ã‚’åŠ¹ç‡çš„ã«å®Ÿè¡Œ
  fast-ci:
    name: Fast CI Pipeline (Optimized)
    runs-on: ubuntu-latest
    
    # GitHub Tokenæ¨©é™è¨­å®š
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆæœ€é©åŒ–ã«ã‚ˆã‚ŠçŸ­ç¸®ï¼‰
    timeout-minutes: 8
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # æ·±ã„å±¥æ­´ã¯ä¸è¦ - é«˜é€ŸåŒ–
        fetch-depth: 1
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 2025å¹´æœ€æ–°: Gradle Build Action ã§æœ€å¤§é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã‚’å®Ÿç¾
    - name: Setup Gradle with advanced caching
      uses: gradle/gradle-build-action@v3
      with:
        gradle-home-cache-cleanup: true
        cache-read-only: ${{ github.event_name == 'pull_request' }}
        # Build Scan ã§ç¶™ç¶šçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        build-scan-publish: true
        build-scan-terms-of-use-agree: "yes"
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šé–‹å§‹
    - name: Record build start time
      run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
      
    # ä¸¦åˆ—å®Ÿè¡Œ: ãƒ†ã‚¹ãƒˆ + ãƒªãƒ³ãƒˆ + ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã‚’åŒæ™‚å®Ÿè¡Œ
    - name: Run tests, lint, and build in parallel
      run: |
        # å¢—åˆ†ãƒ“ãƒ«ãƒ‰ã‚’æ´»ç”¨ï¼ˆcleanãªã—ï¼‰- å¤§å¹…ãªæ™‚é–“çŸ­ç¸®
        echo "ğŸš€ Starting optimized parallel build..."
        ./gradlew --parallel --max-workers=4 \
          testDebugUnitTest \
          lintDebug \
          assembleDebug \
          --stacktrace \
          --continue \
          --build-cache \
          --configuration-cache
      env:
        # 2025å¹´æœ€é©åŒ–: CIç’°å¢ƒå°‚ç”¨ãƒ¡ãƒ¢ãƒªè¨­å®šï¼ˆG1GCçµ±ä¸€ï¼‰
        GRADLE_OPTS: "-Xmx3g -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:G1HeapRegionSize=8m"
        CI: "true"
        # ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ€é©åŒ–
        ORG_GRADLE_PROJECT_android.enableBuildCache: "true"
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šã¨çµæœè¡¨ç¤º
    - name: Calculate and display build time
      run: |
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        echo "â±ï¸ Build completed in ${BUILD_DURATION} seconds"
        echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
        
        # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        echo "âœ… Fast CI Pipeline completed successfully!"
        echo "ğŸ“Š Performance metrics:"
        echo "   - Build time: ${BUILD_DURATION}s"
        echo "   - Parallel workers: 4"
        echo "   - Configuration cache: enabled"
        echo "   - Build cache: enabled"
      
    # é«˜é€Ÿãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Fast CI Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit
        fail-on-error: false
        
    # æ¡ä»¶ä»˜ãã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç”Ÿæˆï¼ˆå¤±æ•—æ™‚ã¯è©³ç´°ã€æˆåŠŸæ™‚ã¯æœ€å°é™ï¼‰
    - name: Upload debug APK (success only)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: debug-apk-${{ github.run_number }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–
        
    - name: Upload detailed logs (failure only)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: failure-logs-${{ github.run_number }}
        path: |
          **/build/reports/
          **/build/test-results/
        retention-days: 3  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–

  # è¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ã¿å®Ÿè¡Œã—ã€mainãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸æ™‚ã¯çœç•¥ï¼‰
  extended-checks:
    name: Extended Checks (PR Only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: fast-ci
    
    timeout-minutes: 6
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle with caching
      uses: gradle/gradle-build-action@v3
      with:
        cache-read-only: true  # PRã§ã¯èª­ã¿å–ã‚Šå°‚ç”¨
        gradle-home-cache-cleanup: true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # Detektå®Ÿè¡Œï¼ˆlintã¯æ—¢ã«fast-ciã§å®Ÿè¡Œæ¸ˆã¿ï¼‰
    - name: Run Detekt analysis
      run: ./gradlew detekt --stacktrace
      env:
        GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=384m -XX:+UseG1GC -XX:+UseStringDeduplication"
        CI: "true"
      
    # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆãƒ†ã‚¹ãƒˆã¯æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ãªã®ã§ã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®ã¿ï¼‰
    - name: Generate code coverage report
      run: ./gradlew jacocoTestReport --stacktrace
      env:
        GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=384m -XX:+UseG1GC -XX:+UseStringDeduplication"
        CI: "true"
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: 'app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml'
        flags: unittests
        fail_ci_if_error: false
        
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          **/build/reports/detekt/
          app/config/detekt/baseline.xml
        retention-days: 3