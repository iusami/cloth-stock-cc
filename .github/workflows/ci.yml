name: Continuous Integration

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒpush + mainã¸ã®PRï¼ˆé‡è¤‡å®Ÿè¡Œæ’é™¤ï¼‰
on:
  push:
    branches: [ 'main' ]  # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼ˆãƒãƒ¼ã‚¸å¾Œã®å“è³ªç¢ºèªï¼‰
  pull_request:
    branches: [ 'main' ]  # mainã¸ã®PRã®ã¿ï¼ˆé–‹ç™ºãƒ†ã‚¹ãƒˆï¼‰

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼ˆGitHub Freeãƒ—ãƒ©ãƒ³å¯¾å¿œï¼šå˜ä¸€ã‚¸ãƒ§ãƒ–å®Ÿè¡Œï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # GitHub Freeå¯¾å¿œï¼šå˜ä¸€çµ±åˆCIã‚¸ãƒ§ãƒ–ï¼ˆä¸¦è¡Œã‚¸ãƒ§ãƒ–åˆ¶é™å›é¿ï¼‰
  unified-ci:
    name: Unified CI Pipeline (Free Plan Optimized)
    runs-on: ubuntu-latest
    
    # GitHub Tokenæ¨©é™è¨­å®š
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆå®‰å®šæ€§é‡è¦–ã§å»¶é•·ï¼‰
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # æ·±ã„å±¥æ­´ã¯ä¸è¦ - é«˜é€ŸåŒ–
        fetch-depth: 1
      
    # ğŸš€ GitHub Freeæœ€é©åŒ–: è»½é‡ã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ2GBï¼‰
    - name: Create lightweight swap for Free plan
      run: |
        echo "ğŸ”§ Creating 2GB swap file for GitHub Free plan optimization..."
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "âœ… Lightweight swap created successfully"
        # ãƒ¡ãƒ¢ãƒªçŠ¶æ³ç¢ºèª
        echo "ğŸ“Š Memory status:"
        free -h
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 2025å¹´æœ€æ–°: Gradle Build Action ã§æœ€å¤§é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã‚’å®Ÿç¾
    - name: Setup Gradle with advanced caching
      uses: gradle/gradle-build-action@v3
      with:
        gradle-home-cache-cleanup: true
        cache-read-only: ${{ github.event_name == 'pull_request' }}
        # Build Scan ã§ç¶™ç¶šçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        build-scan-publish: true
        build-scan-terms-of-use-agree: "yes"
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šé–‹å§‹
    - name: Record build start time
      run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
      
    # GitHub Freeå¯¾å¿œ: å˜ä¸€ã‚¹ãƒ†ãƒƒãƒ—ã§å…¨ã¦ã®ã‚¿ã‚¹ã‚¯ã‚’é †æ¬¡å®Ÿè¡Œ
    - name: Run unified CI tasks (Free plan optimized)
      run: |
        echo "ğŸš€ Starting unified CI pipeline for GitHub Free plan..."
        
        # Step 1: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆä¸¦åˆ—åº¦ã‚’ä¸‹ã’ã¦ãƒ¡ãƒ¢ãƒªåŠ¹ç‡åŒ–ï¼‰
        echo "ğŸ§ª Running tests..."
        ./gradlew --parallel --max-workers=2 testDebugUnitTest --stacktrace --build-cache
        
        # Step 2: ãƒªãƒ³ãƒˆå®Ÿè¡Œ
        echo "ğŸ” Running lint..."
        ./gradlew lintDebug --stacktrace --build-cache
        
        # Step 3: APKãƒ“ãƒ«ãƒ‰
        echo "ğŸ”¨ Building debug APK..."
        ./gradlew assembleDebug --stacktrace --build-cache
        
        echo "âœ… All CI tasks completed successfully!"
      env:
        # GitHub Freeå¯¾å¿œï¼šè»½é‡ãƒ¡ãƒ¢ãƒªè¨­å®šï¼ˆ2GBã‚¹ãƒ¯ãƒƒãƒ—ä½¿ç”¨ï¼‰
        GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication"
        CI: "true"
        ORG_GRADLE_PROJECT_android.enableBuildCache: "true"
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šã¨çµæœè¡¨ç¤º
    - name: Calculate and display build time
      run: |
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        echo "â±ï¸ Build completed in ${BUILD_DURATION} seconds"
        echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
        
        # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        echo "âœ… Fast CI Pipeline completed successfully!"
        echo "ğŸ“Š Performance metrics:"
        echo "   - Build time: ${BUILD_DURATION}s"
        echo "   - Parallel workers: 2 (Free plan optimized)"
        echo "   - Memory allocation: 2GB + 2GB swap"
        echo "   - Build cache: enabled"
      
    # é«˜é€Ÿãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Unified CI Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit
        fail-on-error: false
        
    # æ¡ä»¶ä»˜ãã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç”Ÿæˆï¼ˆå¤±æ•—æ™‚ã¯è©³ç´°ã€æˆåŠŸæ™‚ã¯æœ€å°é™ï¼‰
    - name: Upload debug APK (success only)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: debug-apk-${{ github.run_number }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–
        
    - name: Upload detailed logs (failure only)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: failure-logs-${{ github.run_number }}
        path: |
          **/build/reports/
          **/build/test-results/
        retention-days: 3  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–

  # è¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼ˆPRã®ã¿ã€GitHub Freeå¯¾å¿œã§è»½é‡åŒ–ï¼‰
  extended-checks:
    name: Extended Checks (PR Only - Free Plan)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: unified-ci
    
    timeout-minutes: 6
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle with caching
      uses: gradle/gradle-build-action@v3
      with:
        cache-read-only: true  # PRã§ã¯èª­ã¿å–ã‚Šå°‚ç”¨
        gradle-home-cache-cleanup: true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # Detektå®Ÿè¡Œï¼ˆGitHub Freeå¯¾å¿œï¼‰
    - name: Run Detekt analysis
      run: ./gradlew detekt --stacktrace
      env:
        GRADLE_OPTS: "-Xmx1500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC"
        CI: "true"
      
    # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆGitHub Freeå¯¾å¿œï¼‰
    - name: Generate code coverage report
      run: ./gradlew jacocoTestReport --stacktrace
      env:
        GRADLE_OPTS: "-Xmx1500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC"
        CI: "true"
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: 'app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml'
        flags: unittests
        fail_ci_if_error: false
        
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          **/build/reports/detekt/
          app/config/detekt/baseline.xml
        retention-days: 3