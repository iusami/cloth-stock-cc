name: Continuous Integration

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼: mainãƒ–ãƒ©ãƒ³ãƒpush + mainã¸ã®PRï¼ˆé‡è¤‡å®Ÿè¡Œæ’é™¤ï¼‰
on:
  push:
    branches: [ 'main' ]  # mainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼ˆãƒãƒ¼ã‚¸å¾Œã®å“è³ªç¢ºèªï¼‰
  pull_request:
    branches: [ 'main' ]  # mainã¸ã®PRã®ã¿ï¼ˆé–‹ç™ºãƒ†ã‚¹ãƒˆï¼‰

# ä¸¦è¡Œå®Ÿè¡Œåˆ¶å¾¡ï¼ˆåŒã˜PRã§è¤‡æ•°å›å®Ÿè¡Œæ™‚ã¯æœ€æ–°ã®ã¿ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # çµ±åˆã•ã‚ŒãŸé«˜é€ŸCIã‚¸ãƒ§ãƒ– - 4ã‚³ã‚¢ãƒ©ãƒ³ãƒŠãƒ¼ã§æœ€é«˜æ€§èƒ½ã‚’å®Ÿç¾
  fast-ci:
    name: Fast CI Pipeline (4-Core Optimized)
    runs-on: ubuntu-latest-4-cores
    
    # GitHub Tokenæ¨©é™è¨­å®š
    permissions:
      contents: read
      actions: read
      checks: write
      pull-requests: write
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆå®‰å®šæ€§é‡è¦–ã§å»¶é•·ï¼‰
    timeout-minutes: 15
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # æ·±ã„å±¥æ­´ã¯ä¸è¦ - é«˜é€ŸåŒ–
        fetch-depth: 1
      
    # ğŸš€ ãƒ¡ãƒ¢ãƒªåˆ¶ç´„è§£æ±º: 15GBã‚¹ãƒ¯ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ ï¼ˆæœ€é‡è¦æœ€é©åŒ–ï¼‰
    - name: Create swap file to solve memory constraints
      run: |
        echo "ğŸ”§ Creating 15GB swap file to solve GitHub Actions 7GB RAM limit..."
        sudo fallocate -l 15G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "âœ… Swap file created successfully"
        # ãƒ¡ãƒ¢ãƒªçŠ¶æ³ç¢ºèª
        echo "ğŸ“Š Memory status after swap creation:"
        free -h
        echo "ğŸ’¾ Available memory: $(free -h | awk '/^Mem:/ {print $7}')"
        echo "ğŸ”„ Swap space: $(free -h | awk '/^Swap:/ {print $2}')"
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    # 2025å¹´æœ€æ–°: Gradle Build Action ã§æœ€å¤§é™ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡ã‚’å®Ÿç¾
    - name: Setup Gradle with advanced caching
      uses: gradle/gradle-build-action@v3
      with:
        gradle-home-cache-cleanup: true
        cache-read-only: ${{ github.event_name == 'pull_request' }}
        # Build Scan ã§ç¶™ç¶šçš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        build-scan-publish: true
        build-scan-terms-of-use-agree: "yes"
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šé–‹å§‹
    - name: Record build start time
      run: echo "BUILD_START_TIME=$(date +%s)" >> $GITHUB_ENV
      
    # æ®µéšçš„å®Ÿè¡Œ: ã¾ãšãƒ†ã‚¹ãƒˆã¨ãƒªãƒ³ãƒˆã‚’ä¸¦åˆ—å®Ÿè¡Œï¼ˆ4ã‚³ã‚¢æœ€å¤§æ´»ç”¨ï¼‰
    - name: Run tests and lint in parallel
      run: |
        echo "ğŸš€ Starting tests and lint..."
        ./gradlew --parallel --max-workers=4 \
          testDebugUnitTest \
          lintDebug \
          --stacktrace \
          --continue \
          --build-cache
      env:
        # CIç’°å¢ƒå°‚ç”¨ãƒ¡ãƒ¢ãƒªè¨­å®šï¼ˆ15GBã‚¹ãƒ¯ãƒƒãƒ—ã§ãƒ¡ãƒ¢ãƒªåˆ¶ç´„è§£æ±ºæ¸ˆã¿ï¼‰
        GRADLE_OPTS: "-Xmx3500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:G1HeapRegionSize=16m"
        CI: "true"
        ORG_GRADLE_PROJECT_android.enableBuildCache: "true"
        
    # æ¬¡ã«APKãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
    - name: Build debug APK
      run: |
        echo "ğŸ”¨ Building APK..."
        ./gradlew assembleDebug --stacktrace --build-cache
      env:
        # APKãƒ“ãƒ«ãƒ‰ç”¨ãƒ¡ãƒ¢ãƒªè¨­å®šï¼ˆãƒ¡ãƒ¢ãƒªåˆ¶ç´„è§£æ±ºæ¸ˆã¿ã§å¤§å®¹é‡åŒ–ï¼‰
        GRADLE_OPTS: "-Xmx3500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:G1HeapRegionSize=16m"
        CI: "true"
        ORG_GRADLE_PROJECT_android.enableBuildCache: "true"
      
    # ãƒ“ãƒ«ãƒ‰æ™‚é–“æ¸¬å®šã¨çµæœè¡¨ç¤º
    - name: Calculate and display build time
      run: |
        BUILD_END_TIME=$(date +%s)
        BUILD_DURATION=$((BUILD_END_TIME - BUILD_START_TIME))
        echo "â±ï¸ Build completed in ${BUILD_DURATION} seconds"
        echo "BUILD_DURATION=${BUILD_DURATION}" >> $GITHUB_ENV
        
        # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        echo "âœ… Fast CI Pipeline completed successfully!"
        echo "ğŸ“Š Performance metrics:"
        echo "   - Build time: ${BUILD_DURATION}s"
        echo "   - Parallel workers: 4 (max utilization)"
        echo "   - Configuration cache: enabled"
        echo "   - Build cache: enabled"
      
    # é«˜é€Ÿãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
    - name: Generate test report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: Fast CI Test Results
        path: '**/build/test-results/testDebugUnitTest/TEST-*.xml'
        reporter: java-junit
        fail-on-error: false
        
    # æ¡ä»¶ä»˜ãã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç”Ÿæˆï¼ˆå¤±æ•—æ™‚ã¯è©³ç´°ã€æˆåŠŸæ™‚ã¯æœ€å°é™ï¼‰
    - name: Upload debug APK (success only)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: debug-apk-${{ github.run_number }}
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 7  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–
        
    - name: Upload detailed logs (failure only)
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: failure-logs-${{ github.run_number }}
        path: |
          **/build/reports/
          **/build/test-results/
        retention-days: 3  # çŸ­ç¸®ã—ã¦ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸åŠ¹ç‡åŒ–

  # è¿½åŠ ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ã¿å®Ÿè¡Œã—ã€mainãƒ–ãƒ©ãƒ³ãƒãƒãƒ¼ã‚¸æ™‚ã¯çœç•¥ï¼‰
  extended-checks:
    name: Extended Checks (PR Only - 4-Core)
    runs-on: ubuntu-latest-4-cores
    if: github.event_name == 'pull_request'
    needs: fast-ci
    
    timeout-minutes: 6
    
    permissions:
      contents: read
      actions: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle with caching
      uses: gradle/gradle-build-action@v3
      with:
        cache-read-only: true  # PRã§ã¯èª­ã¿å–ã‚Šå°‚ç”¨
        gradle-home-cache-cleanup: true
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    # Detektå®Ÿè¡Œï¼ˆlintã¯æ—¢ã«fast-ciã§å®Ÿè¡Œæ¸ˆã¿ï¼‰
    - name: Run Detekt analysis
      run: ./gradlew detekt --stacktrace
      env:
        GRADLE_OPTS: "-Xmx3500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:G1HeapRegionSize=16m"
        CI: "true"
      
    # ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ï¼ˆãƒ†ã‚¹ãƒˆã¯æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ãªã®ã§ã€ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã®ã¿ï¼‰
    - name: Generate code coverage report
      run: ./gradlew jacocoTestReport --stacktrace
      env:
        GRADLE_OPTS: "-Xmx3500m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:G1HeapRegionSize=16m"
        CI: "true"
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: 'app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml'
        flags: unittests
        fail_ci_if_error: false
        
    - name: Upload analysis results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: analysis-results-${{ github.run_number }}
        path: |
          **/build/reports/detekt/
          app/config/detekt/baseline.xml
        retention-days: 3